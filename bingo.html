<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ€ å¹´æœ«ã‚¸ãƒ£ãƒ³ãƒœ ãƒ“ãƒ³ã‚´å¤§ä¼š ğŸ€</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
body{
  font-family:'Hiragino Kaku Gothic ProN', sans-serif;
  text-align:center;
  padding:20px;

  background:
    linear-gradient(
      180deg,
      #fff6e3 0%,
      #fff3d6 35%,
      #fff9ec 70%,
      #ffffff 100%
    );
}







h1{ color:#e67cb8; }

/* ===== ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ ===== */
#bingo-card{
  display:grid;
  grid-template-columns:repeat(5,60px);
  gap:6px;
  justify-content:center;
  margin:20px auto;
}

.cell{
  width:60px;
  height:60px;
  line-height:60px;
  border-radius:10px;
  font-weight:bold;
  background:#fff;
  border:2px solid #ccc;
}

.cell.marked {
  background: linear-gradient(135deg,#ffd6e7,#fff);
  color:#e60073;
  box-shadow: inset 0 0 6px rgba(255,105,180,.6);
}
/* ===== ãƒªãƒ¼ãƒæ¼”å‡ºï¼ˆãƒ”ãƒ³ã‚¯ï¼‰ ===== */
.cell.reach {
  animation: reachGlowPink 1.2s infinite;
}

@keyframes reachGlowPink {
  0%   { box-shadow: 0 0 0 rgba(255,105,180,0); }
  50%  { box-shadow: 0 0 18px rgba(255,105,180,.9); }
  100% { box-shadow: 0 0 0 rgba(255,105,180,0); }
}

/* ===== ãƒ“ãƒ³ã‚´åˆ—ï¼ˆé»„è‰²ï¼‰ ===== */
.cell.bingo-line {
  animation: bingoLineGlowYellow 1.2s infinite;
}

@keyframes bingoLineGlowYellow {
  0%   { box-shadow: 0 0 6px rgba(255,215,0,.4); }
  50%  { box-shadow: 0 0 22px rgba(255,215,0,1); }
  100% { box-shadow: 0 0 6px rgba(255,215,0,.4); }
}

/* ===== ã‚«ãƒ¼ãƒ‰å…¨ä½“ãƒ“ãƒ³ã‚´ï¼ˆé»„è‰²ï¼‰ ===== */
.card-bingo {
  animation: bingoCardGlowYellow 1.5s infinite;
  transform: scale(1.03);
}

@keyframes bingoCardGlowYellow {
  0%   { box-shadow: 0 0 10px rgba(255,215,0,.6); }
  50%  { box-shadow: 0 0 32px rgba(255,215,0,1); }
  100% { box-shadow: 0 0 10px rgba(255,215,0,.6); }
}


/* ã‚«ãƒ¼ãƒ‰è‰² */
.card-red .cell{ border-color:#e74c3c; }
.card-blue .cell{ border-color:#3498db; }
.card-yellow .cell{ border-color:#f1c40f; }

/* ===== æŠ½é¸è¡¨ç¤º ===== */
.info{
  margin:12px 0;
}

/* ===== å‚åŠ è€…ä¸€è¦§ ===== */
#players{
  margin-top:20px;
}

.player{
  display:inline-flex;
  align-items:center;
  gap:6px;
  margin:6px;
  padding:6px 10px;
  border-radius:999px;
  background:#fff;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
}

.player .status{
  font-size:12px;
  opacity:.7;
}
/* ===== æŠ½é¸ãƒœã‚¿ãƒ³ ===== */
.draw-area{
  margin:16px 0 10px;
}

#draw-btn{
  padding:12px 22px;
  font-size:16px;
  font-weight:700;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#ff8fb6,#ff5f9e);
  color:#fff;
  cursor:pointer;
  box-shadow:0 6px 18px rgba(255,120,170,.5);
  transition:.2s;
}

#draw-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 22px rgba(255,120,170,.7);
}
/* ===== èŠ±ç« ===== */
#fireworks{
  position:fixed;
  inset:0;
  pointer-events:none;
  overflow:hidden;
  z-index:9999;
}

.firework{
  position:absolute;
  width:10px;
  height:10px;
  border-radius:50%;
  animation: explode 1.2s ease-out forwards;
}

@keyframes explode{
  0%{
    transform:scale(0);
    opacity:1;
  }
  70%{
    transform:scale(5);
    opacity:1;
  }
  100%{
    transform:scale(8);
    opacity:0;
  }
}
#reset-btn{
  padding:10px 18px;
  font-size:14px;
  font-weight:700;
  border:none;
  border-radius:999px;
  background:#bbb;
  color:#fff;
  cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,.2);
  transition:.2s;
}

#reset-btn:hover{
  background:#999;
}
/* ===== è‡ªåˆ†ã®æƒ…å ± ===== */
.my-info{
  display:inline-flex;
  align-items:center;
  gap:8px;
  margin:10px auto 6px;
  padding:6px 14px;
  border-radius:999px;
  background:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
  font-weight:700;
}

.my-icon{
  font-size:22px;
}

.my-name{
  color:#e67cb8;
}
.rank{
  font-weight:900;
  color:#ff9800;
  margin-right:4px;
}
/* ===== é †ä½ã‚«ãƒ©ãƒ¼ ===== */
.rank{
  font-weight:900;
  margin-right:6px;
}

.rank-1{
  color:#d4af37; /* é‡‘ */
  text-shadow:0 0 6px rgba(212,175,55,.8);
}

.rank-2{
  color:#c0c0c0; /* éŠ€ */
}

.rank-3{
  color:#cd7f32; /* éŠ… */
}
/* ===== å„ªå‹è€…ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===== */
#winner-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10000;
}

#winner-overlay.show{
  display:flex;
}

.winner-box{
  background:linear-gradient(135deg,#fff4c1,#ffe28a);
  padding:40px 70px;
  border-radius:30px;
  text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
  animation: winnerPop .9s ease-out;
}

@keyframes winnerPop{
  0%{ transform:scale(.3); opacity:0; }
  70%{ transform:scale(1.1); opacity:1; }
  100%{ transform:scale(1); }
}

.winner-rank{
  font-size:36px;
  font-weight:900;
  color:#d4af37;
  text-shadow:0 0 12px rgba(212,175,55,.9);
}

.winner-name{
  margin-top:12px;
  font-size:48px;
  font-weight:900;
  color:#c0392b;
}

.player-icon-img{
  width:36px;
  height:36px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid #ff8fb6;
}
.player-icon-emoji{
  font-size:28px;
}
.card-viewer{
  margin:20px auto;
  padding:16px;
  background:#fff;
  border-radius:20px;
  width:max-content;
  box-shadow:0 8px 30px rgba(255,120,170,.35);
}

.card-viewer.hidden{
  display:none;
}

.viewer-grid{
  display:grid;
  grid-template-columns:repeat(5,48px);
  gap:6px;
}

.viewer-cell{
  width:48px;
  height:48px;
  line-height:48px;
  border-radius:10px;
  font-weight:bold;
  background:#fff;
  border:2px solid #ff8fb6;
  text-align:center;
}

.viewer-cell.marked{
  background:#ffe0ec;
  color:#e60073;
}
/* ===== ãƒªãƒ¼ãƒæ¼”å‡º ===== */
.card-reach {
  animation: reachGlow 1.2s infinite;
}

@keyframes reachGlow {
  0% {
    box-shadow: 0 0 0px rgba(255, 180, 0, 0.0);
  }
  50% {
    box-shadow: 0 0 18px rgba(255, 180, 0, 0.9);
  }
  100% {
    box-shadow: 0 0 0px rgba(255, 180, 0, 0.0);
  }
}


@keyframes bingoGlow {
  0% {
    box-shadow: 0 0 10px rgba(255, 105, 180, 0.6);
  }
  50% {
    box-shadow: 0 0 30px rgba(255, 215, 0, 1);
  }
  100% {
    box-shadow: 0 0 10px rgba(255, 105, 180, 0.6);
  }
}
/* ===== ãƒ“ãƒ³ã‚´åˆ— ===== */
.cell.bingo-line {
  animation: bingoLineGlow 1.2s infinite;
}

@keyframes bingoLineGlow {
  0%   { box-shadow: 0 0 6px rgba(255,215,0,.4); }
  50%  { box-shadow: 0 0 20px rgba(255,215,0,1); }
  100% { box-shadow: 0 0 6px rgba(255,215,0,.4); }
}

/* ===== ã‚«ãƒ¼ãƒ‰å…¨ä½“ ===== */
.card-bingo {
  animation: bingoCardGlow 1.5s infinite;
  transform: scale(1.03);
}

@keyframes bingoCardGlow {
  0%   { box-shadow: 0 0 10px rgba(255,105,180,.5); }
  50%  { box-shadow: 0 0 30px rgba(255,215,0,1); }
  100% { box-shadow: 0 0 10px rgba(255,105,180,.5); }
}
@keyframes drawRoll {
  0% { transform: translateY(0); }
  50% { transform: translateY(-6px); }
  100% { transform: translateY(0); }
}

#draw-rolling {
  animation: drawRoll .1s infinite;
}







</style>
</head>

<body>

<h1>ğŸ€ å¹´æœ«ã‚¸ãƒ£ãƒ³ãƒœ ãƒ“ãƒ³ã‚´å¤§ä¼š ğŸ€</h1>
<!-- ğŸ‘¤ è‡ªåˆ†ã®æƒ…å ± -->
<div id="my-info" class="my-info">
  <span class="my-icon">ğŸ™‚</span>
  <span class="my-name">---</span>
</div>

<div id="bingo-card"></div>

<div class="draw-area">
  <button id="draw-btn" onclick="drawNumber()">ğŸ² ç•ªå·ã‚’ã²ã</button>
  <br><br>
  <button id="reset-btn" onclick="resetDraw()">ğŸ”„ æŠ½é¸ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
</div>
<div class="info">
  æœ€æ–°ç•ªå·ï¼š<b id="last-number">â€“</b><br>
</div>

<h2>ğŸŒ¸ å‚åŠ è€…ä¸€è¦§</h2>
<div id="players"></div>
<!-- ğŸ‘‡ å‚åŠ è€…ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div id="viewer" class="card-viewer hidden"></div>

<script>
  /* ===== ã‹ã‚ã„ã„åŠ¹æœéŸ³ï¼ˆWeb Audio APIï¼‰ ===== */
let audioCtx = null;
let drumTimer = null;

function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

/* ğŸ€ æŠ½é¸ä¸­ï¼šã‹ã‚ã„ã„ãƒã‚³ãƒã‚³éŸ³ */
function startDrumRoll(){
  ensureAudio();

  let step = 0;
  drumTimer = setInterval(()=>{
    // ãƒ¡ã‚¤ãƒ³éŸ³ï¼ˆãƒã‚³ï¼‰
    const osc1 = audioCtx.createOscillator();
    const gain1 = audioCtx.createGain();

    osc1.type = "square";
    osc1.frequency.value = 660 + step % 3 * 110; // ãƒ‰ãƒ¬ãƒŸæ„Ÿ
    gain1.gain.value = 0.08;

    osc1.connect(gain1);
    gain1.connect(audioCtx.destination);

    osc1.start();
    osc1.stop(audioCtx.currentTime + 0.06);

    // ã‚­ãƒ©ãƒƒéŸ³ï¼ˆã†ã£ã™ã‚‰ï¼‰
    const osc2 = audioCtx.createOscillator();
    const gain2 = audioCtx.createGain();

    osc2.type = "sine";
    osc2.frequency.value = 1540; // é«˜éŸ³
    gain2.gain.value = 0.04;

    osc2.connect(gain2);
    gain2.connect(audioCtx.destination);

    osc2.start();
    osc2.stop(audioCtx.currentTime + 0.04);

    step++;
  }, 120); // â† ã‚†ã£ãã‚Šã§å¯æ„›ã„
}


/* ğŸ›‘ ãƒ‰ãƒ©ãƒ åœæ­¢ */
function stopDrumRoll(){
  if(drumTimer){
    clearInterval(drumTimer);
    drumTimer = null;
  }
}

/* ğŸ€ ç¢ºå®šéŸ³ï¼ˆã‹ã‚ã„ã„ãƒãƒ¯ãƒ³â™ªï¼‰ */
function playCuteConfirm(){
  ensureAudio();

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = "sine";          // ã¾ã‚‹ã„éŸ³
  osc.frequency.setValueAtTime(880, audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(
    1320,
    audioCtx.currentTime + 0.15
  );

  gain.gain.setValueAtTime(0.18, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(
    0.001,
    audioCtx.currentTime + 0.25
  );

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  osc.start();
  osc.stop(audioCtx.currentTime + 0.25);
}


/* ===== Firebase åˆæœŸåŒ– ===== */
firebase.initializeApp({
  apiKey: "AIzaSyCVofvlR6N837LqdNxRweTq93Uu6qpgbsI",
  authDomain: "sushi-cd085.firebaseapp.com",
  databaseURL: "https://sushi-cd085-default-rtdb.firebaseio.com",
  projectId: "sushi-cd085"
});
const db = firebase.database();

/* ===== åŸºæœ¬æƒ…å ± ===== */
const userId = localStorage.getItem("bingo_user_id");
if(!userId){
  alert("å‚åŠ æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚index.htmlã‹ã‚‰å‚åŠ ã—ã¦ãã ã•ã„ã€‚");
}

const cardEl = document.getElementById("bingo-card");
const lastEl = document.getElementById("last-number");
const listEl = document.getElementById("numbers-list");
const playersEl = document.getElementById("players");

let card = [];
let drawn = [];
let cardType = "red";
let winnerShown = false;


/* ===== è‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ ===== */
db.ref(`events/event1/participants/${userId}`).once("value").then(snap=>{
  const data = snap.val();
  if(!data || !data.card){
    alert("ã‚«ãƒ¼ãƒ‰æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  // ğŸ´ ã‚«ãƒ¼ãƒ‰æƒ…å ±
  card = data.card;
  cardType = data.cardType || "red";
  cardEl.className = `card-${cardType}`;
  renderCard();

  // ğŸ‘¤ è‡ªåˆ†ã®è¡¨ç¤º
// ğŸ‘¤ è‡ªåˆ†ã®è¡¨ç¤ºï¼ˆä¿®æ­£ç‰ˆï¼‰
const myIconEl = document.querySelector(".my-icon");
const myNameEl = document.querySelector(".my-name");

myNameEl.textContent = data.name;

if(data.iconType === "image"){
  myIconEl.innerHTML = `<img src="${data.icon}" class="player-icon-img">`;
}else{
  myIconEl.textContent = data.icon || "ğŸ™‚";
}
});


/* ===== ã‚«ãƒ¼ãƒ‰æç”» ===== */
function renderCard(){
  cardEl.innerHTML="";
  card.forEach(v=>{
    const d = document.createElement("div");
    d.className="cell";
    d.textContent = v;
    if(v==="FREE" || drawn.includes(v)) d.classList.add("marked");
    cardEl.appendChild(d);
  });
}

/* ===== æŠ½é¸ç•ªå·åŒæœŸ ===== */
db.ref("events/event1/drawnNumbers").on("value", snap=>{
  drawn = snap.val() || [];
  lastEl.textContent = drawn.at(-1) ?? "â€“";
  listEl.textContent = drawn.length ? drawn.join("ãƒ»") : "ï¼ˆã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰";
  renderCard();
  checkStatus();
});

/* ===== ãƒªãƒ¼ãƒï¼ãƒ“ãƒ³ã‚´åˆ¤å®š ===== */
function checkStatus(){
const myRef = db.ref(`events/event1/participants/${userId}`);
  // ã„ã£ãŸã‚“å…¨æ¼”å‡ºã‚’ãƒªã‚»ãƒƒãƒˆ
document.querySelectorAll(".cell").forEach(c=>{
  c.classList.remove("reach", "bingo-line");
});
cardEl.classList.remove("card-reach", "card-bingo");

  if(!card.length) return;

  const marked = card.map(v => v==="FREE" || drawn.includes(v));
  const lines = [];

  for(let r=0;r<5;r++) lines.push([0,1,2,3,4].map(c=>marked[r*5+c]));
  for(let c=0;c<5;c++) lines.push([0,1,2,3,4].map(r=>marked[r*5+c]));
  lines.push([0,6,12,18,24].map(i=>marked[i]));
  lines.push([4,8,12,16,20].map(i=>marked[i]));

  let status="å‚åŠ ä¸­";
cardEl.classList.remove("card-reach", "card-bingo");

let bingoLineIndexes = [];

// ãƒ“ãƒ³ã‚´åˆ¤å®šï¼ˆã©ã®ãƒ©ã‚¤ãƒ³ã‹ç‰¹å®šï¼‰
lines.forEach((line, idx)=>{
  if(line.every(v=>v)){
    if(idx < 5){ // æ¨ª
      bingoLineIndexes.push([0,1,2,3,4].map(c => idx*5 + c));
    }
    else if(idx < 10){ // ç¸¦
      const col = idx - 5;
      bingoLineIndexes.push([0,1,2,3,4].map(r => r*5 + col));
    }
    else if(idx === 10){ // æ–œã‚ \
      bingoLineIndexes.push([0,6,12,18,24]);
    }
    else if(idx === 11){ // æ–œã‚ /
      bingoLineIndexes.push([4,8,12,16,20]);
    }
  }
});

if(bingoLineIndexes.length){
  status = "ãƒ“ãƒ³ã‚´";
  cardEl.classList.add("card-bingo");

  bingoLineIndexes.flat().forEach(i=>{
    cardEl.children[i].classList.add("bingo-line");
  });

  // ğŸ”¥ã€è¿½åŠ ã€‘ãƒ“ãƒ³ã‚´çŠ¶æ…‹ã‚’DBã¸ä¿å­˜
  db.ref(`events/event1/participants/${userId}`).update({
    status: "ãƒ“ãƒ³ã‚´",
    bingoAt: Date.now()
  });

  playBingoEffect();
  return; // â† ãƒªãƒ¼ãƒåˆ¤å®šã‚’æ­¢ã‚ã‚‹ï¼ˆé‡è¦ï¼‰
}

// ã„ã£ãŸã‚“ãƒªãƒ¼ãƒæ¼”å‡ºã‚’å…¨éƒ¨æ¶ˆã™
document.querySelectorAll(".cell").forEach(c=>{
  c.classList.remove("reach");
});

let reachLineIndex = -1;

lines.forEach((line, idx)=>{
  if(line.filter(v=>v).length === 4 && line.includes(false)){
    reachLineIndex = idx;
  }
});

if(reachLineIndex !== -1){
  status = "ãƒªãƒ¼ãƒ";
   db.ref(`events/event1/participants/${userId}`).update({
    status: "ãƒªãƒ¼ãƒ"
  });

  // ãƒªãƒ¼ãƒã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ³ã® index é…åˆ—ã‚’å–å¾—
  let indexes = [];

  if(reachLineIndex < 5){ // æ¨ª
    indexes = [0,1,2,3,4].map(c => reachLineIndex*5 + c);
  }
  else if(reachLineIndex < 10){ // ç¸¦
    const col = reachLineIndex - 5;
    indexes = [0,1,2,3,4].map(r => r*5 + col);
  }
  else if(reachLineIndex === 10){ // æ–œã‚ \
    indexes = [0,6,12,18,24];
  }
  else if(reachLineIndex === 11){ // æ–œã‚ /
    indexes = [4,8,12,16,20];
  }

  indexes.forEach(i=>{
    cardEl.children[i].classList.add("reach");
  });
}


}

/* ===== å‚åŠ è€…ä¸€è¦§ ===== */
db.ref("events/event1/participants").on("value", snap=>{
  playersEl.innerHTML="";
  const data = snap.val();
  if(!data) return;

// ãƒ“ãƒ³ã‚´é”æˆè€… â†’ å‚åŠ ä¸­ ã®é †ã«ä¸¦ã¹ã‚‹
const players = Object.values(data);

// ãƒ“ãƒ³ã‚´é”æˆè€…ï¼ˆé”æˆé †ï¼‰
const bingoPlayers = players
  .filter(p => p.status === "ãƒ“ãƒ³ã‚´" && p.bingoAt)
  .sort((a,b) => a.bingoAt - b.bingoAt);

// ãã®ä»–
const others = players.filter(p => p.status !== "ãƒ“ãƒ³ã‚´");

// çµåˆ
const ordered = [...bingoPlayers, ...others];

Object.entries(data).forEach(([id, p], index)=>{
  const div = document.createElement("div");
  div.className = "player";

  let rankHtml = "";

  if(p.status === "ãƒ“ãƒ³ã‚´"){
    const rank = index + 1;

    if(rank === 1){
      rankHtml = `<span class="rank rank-1">ğŸ¥‡ 1ä½</span>`;
      playGoldFanfare();
      showWinner(p.name); // ğŸ‘‘ ãƒ‰ãƒ¼ãƒ³è¡¨ç¤º
    }
    else if(rank === 2){
      rankHtml = `<span class="rank rank-2">ğŸ¥ˆ 2ä½</span>`;
    }
    else if(rank === 3){
      rankHtml = `<span class="rank rank-3">ğŸ¥‰ 3ä½</span>`;
    }
    else{
      rankHtml = `<span class="rank">${rank}ä½</span>`;
    }
  }

let iconHtml = "";

if(p.iconType === "image"){
  iconHtml = `<img src="${p.icon}" class="player-icon-img">`;
}else{
  iconHtml = `<span class="player-icon-emoji">${p.icon || "ğŸ™‚"}</span>`;
}

div.innerHTML = `
  ${rankHtml}
  ${iconHtml}
  <span>${p.name}</span>
  <span class="status">${p.status}</span>
`;

 div.addEventListener("click", ()=>{
    togglePlayerCard(p, id); // â† âœ… æ­£ã—ã„ userId
  });





  playersEl.appendChild(div);
});
 });
/* ===== æŠ½é¸å‡¦ç† ===== */
/* ===== æŠ½é¸å‡¦ç†ï¼ˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆä»˜ãï¼‰ ===== */
function drawNumber(){
  const drawBtn = document.getElementById("draw-btn");

  if(drawBtn.disabled) return; // äºŒé‡é˜²æ­¢
  drawBtn.disabled = true;

  if(drawn.length >= 75){
    alert("ã™ã¹ã¦ã®ç•ªå·ãŒå‡ºã¾ã—ãŸï¼");
    drawBtn.disabled = false;
    return;
  }

  const overlay = document.getElementById("draw-overlay");
  const rolling = document.getElementById("draw-rolling");

  overlay.style.display = "flex";
  startDrumRoll();

  const rollTimer = setInterval(()=>{
    rolling.textContent = Math.floor(Math.random()*75)+1;
  }, 80);

  setTimeout(()=>{
    clearInterval(rollTimer);
    stopDrumRoll();

    let n;
    do{
      n = Math.floor(Math.random()*75)+1;
    }while(drawn.includes(n));

    rolling.textContent = n;
    playCuteConfirm();

    setTimeout(()=>{
      // âœ… ã“ã“ã¯ã€Œå¿…ãšå®Ÿè¡Œã•ã‚Œã‚‹ã€
      overlay.style.display = "none";
      drawBtn.disabled = false;

      db.ref("events/event1/drawnNumbers").set([...drawn, n]);
    }, 600);

  }, 1500);
}


// ğŸµ ãƒ“ãƒ³ã‚´åŠ¹æœéŸ³ãƒªã‚¹ãƒˆ
const bingoSounds = [
  "bingo1.mp3",
  "bingo2.mp3",
  "bingo3.mp3"
];

let bingoPlayed = false;

function playBingoEffect(){
  if(bingoPlayed) return;
  bingoPlayed = true;

  // ğŸ”Š åŠ¹æœéŸ³ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
  const sound = document.getElementById("bingo-sound");
  const randomSound = bingoSounds[Math.floor(Math.random() * bingoSounds.length)];
  sound.src = randomSound;
  sound.volume = 0.6;
  sound.currentTime = 0;
  sound.play().catch(()=>{});

  // ğŸ† èŠ±ç«
  const fw = document.getElementById("fireworks");

  for(let i=0;i<12;i++){
    const d = document.createElement("div");
    d.className = "firework";
    d.style.left = Math.random()*100 + "%";
    d.style.top = Math.random()*60 + "%";
    d.style.background = `hsl(${Math.random()*360},100%,60%)`;
    fw.appendChild(d);

    setTimeout(()=>d.remove(), 1300);
  }
}
function resetDraw(){
  if(!confirm("æŠ½é¸ãƒ»é †ä½ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")){
    return;
  }

  const eventRef = db.ref("events/event1");

  // â‘  æŠ½é¸ç•ªå·ãƒªã‚»ãƒƒãƒˆ
  eventRef.child("drawnNumbers").set([]);

  // â‘¡ å‚åŠ è€…ã® status / rank ã‚’åˆæœŸåŒ–
  eventRef.child("participants").once("value").then(snapshot => {
    const updates = {};

    snapshot.forEach(child => {
      updates[`${child.key}/status`] = "å‚åŠ ä¸­";
      updates[`${child.key}/rank`] = null; // rankä½¿ã£ã¦ã‚‹å ´åˆ
      updates[`${child.key}/bingoAt`] = null; // ã‚‚ã—è¨˜éŒ²ã—ã¦ãŸã‚‰
    });

    eventRef.child("participants").update(updates);
  });

  // â‘¢ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒ•ãƒ©ã‚°åˆæœŸåŒ–ï¼ˆæ¼”å‡ºç”¨ï¼‰
  bingoPlayed = false;
}






let goldPlayed = false;

function playGoldFanfare(){
  if(goldPlayed) return;
  goldPlayed = true;

  const fanfare = document.getElementById("fanfare-gold");
  fanfare.volume = 0.8;
  fanfare.currentTime = 0;
  fanfare.play().catch(()=>{});
}
function showWinner(name){
  if(winnerShown) return;
  winnerShown = true;

  // ğŸ‘‘ åå‰è¡¨ç¤º
  document.getElementById("winner-name").textContent = name;
  document.getElementById("winner-overlay").classList.add("show");

  // ğŸ‡ èŠ±ç«å€å¢—
  const fw = document.getElementById("fireworks");
  for(let i=0;i<30;i++){   // â† é€šå¸¸12 â†’ 30
    const d = document.createElement("div");
    d.className="firework";
    d.style.left = Math.random()*100 + "%";
    d.style.top = Math.random()*60 + "%";
    d.style.background = `hsl(${Math.random()*360},100%,60%)`;
    fw.appendChild(d);
    setTimeout(()=>d.remove(), 1300);
  }

  // â± æ•°ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
  setTimeout(()=>{
    document.getElementById("winner-overlay").classList.remove("show");
  }, 4500);
}
let openedUserId = null;
const viewer = document.getElementById("viewer");

function togglePlayerCard(player, userId){
  // åŒã˜äººã‚’ã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ â†’ é–‰ã˜ã‚‹
  if(openedUserId === userId){
    viewer.classList.add("hidden");
    viewer.innerHTML = "";
    openedUserId = null;
    return;
  }

  openedUserId = userId;
  viewer.innerHTML = "";

  const grid = document.createElement("div");
  grid.className = "viewer-grid";

  const marked = player.card.map(v =>
    v === "FREE" || drawn.includes(v)
  );

  player.card.forEach((v,i)=>{
    const d = document.createElement("div");
    d.className = "viewer-cell";
    d.textContent = v;

    if(marked[i]) d.classList.add("marked");
    grid.appendChild(d);
  });

  viewer.appendChild(grid);
  viewer.classList.remove("hidden");
}









</script>




<!-- ğŸ† ãƒ“ãƒ³ã‚´æ¼”å‡º -->
<div id="fireworks"></div>

<audio id="fanfare-gold" preload="auto">
  <source src="fanfare_gold.mp3" type="audio/mpeg">
</audio>
<!-- ğŸ‘‘ å„ªå‹è€…è¡¨ç¤º -->
<div id="winner-overlay">
  <div class="winner-box">
    <div class="winner-rank">ğŸ¥‡ å„ªå‹ ğŸ¥‡</div>
    <div class="winner-name" id="winner-name">---</div>
  </div>
</div>

<!-- ğŸ° æŠ½é¸ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="draw-overlay" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
">
  <div style="
    background:#fff;
    padding:40px 70px;
    border-radius:30px;
    text-align:center;
    box-shadow:0 20px 60px rgba(0,0,0,.4);
  ">
    <div style="font-size:22px;font-weight:700;color:#ff5f9e;">
      æŠ½é¸ä¸­â€¦
    </div>
    <div id="draw-rolling" style="
      margin-top:12px;
      font-size:72px;
      font-weight:900;
    ">??</div>
  </div>
</div>
</body>

</html>
