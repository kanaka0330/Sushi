<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ€ å¹´æœ«ã‚¸ãƒ£ãƒ³ãƒœ ãƒ“ãƒ³ã‚´å¤§ä¼š ğŸ€</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
body{
  font-family:'Hiragino Kaku Gothic ProN', sans-serif;
  background:linear-gradient(135deg,#fff0f6,#e0f7fa);
  text-align:center;
  padding:20px;
}

h1{ color:#e67cb8; }

/* ===== ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ ===== */
#bingo-card{
  display:grid;
  grid-template-columns:repeat(5,60px);
  gap:6px;
  justify-content:center;
  margin:20px auto;
}

.cell{
  width:60px;
  height:60px;
  line-height:60px;
  border-radius:10px;
  font-weight:bold;
  background:#fff;
  border:2px solid #ccc;
}

.cell.marked{
  background:#ffebf3;
  color:#e60073;
}

/* ã‚«ãƒ¼ãƒ‰è‰² */
.card-red .cell{ border-color:#e74c3c; }
.card-blue .cell{ border-color:#3498db; }
.card-yellow .cell{ border-color:#f1c40f; }

/* ===== æŠ½é¸è¡¨ç¤º ===== */
.info{
  margin:12px 0;
}

/* ===== å‚åŠ è€…ä¸€è¦§ ===== */
#players{
  margin-top:20px;
}

.player{
  display:inline-flex;
  align-items:center;
  gap:6px;
  margin:6px;
  padding:6px 10px;
  border-radius:999px;
  background:#fff;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
}

.player .status{
  font-size:12px;
  opacity:.7;
}
/* ===== æŠ½é¸ãƒœã‚¿ãƒ³ ===== */
.draw-area{
  margin:16px 0 10px;
}

#draw-btn{
  padding:12px 22px;
  font-size:16px;
  font-weight:700;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#ff8fb6,#ff5f9e);
  color:#fff;
  cursor:pointer;
  box-shadow:0 6px 18px rgba(255,120,170,.5);
  transition:.2s;
}

#draw-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 22px rgba(255,120,170,.7);
}
/* ===== èŠ±ç« ===== */
#fireworks{
  position:fixed;
  inset:0;
  pointer-events:none;
  overflow:hidden;
  z-index:9999;
}

.firework{
  position:absolute;
  width:10px;
  height:10px;
  border-radius:50%;
  animation: explode 1.2s ease-out forwards;
}

@keyframes explode{
  0%{
    transform:scale(0);
    opacity:1;
  }
  70%{
    transform:scale(5);
    opacity:1;
  }
  100%{
    transform:scale(8);
    opacity:0;
  }
}
#reset-btn{
  padding:10px 18px;
  font-size:14px;
  font-weight:700;
  border:none;
  border-radius:999px;
  background:#bbb;
  color:#fff;
  cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,.2);
  transition:.2s;
}

#reset-btn:hover{
  background:#999;
}
/* ===== è‡ªåˆ†ã®æƒ…å ± ===== */
.my-info{
  display:inline-flex;
  align-items:center;
  gap:8px;
  margin:10px auto 6px;
  padding:6px 14px;
  border-radius:999px;
  background:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
  font-weight:700;
}

.my-icon{
  font-size:22px;
}

.my-name{
  color:#e67cb8;
}

</style>
</head>

<body>

<h1>ğŸ€ å¹´æœ«ã‚¸ãƒ£ãƒ³ãƒœ ãƒ“ãƒ³ã‚´å¤§ä¼š ğŸ€</h1>
<!-- ğŸ‘¤ è‡ªåˆ†ã®æƒ…å ± -->
<div id="my-info" class="my-info">
  <span class="my-icon">ğŸ™‚</span>
  <span class="my-name">---</span>
</div>

<div id="bingo-card"></div>

<div class="draw-area">
  <button id="draw-btn" onclick="drawNumber()">ğŸ² ç•ªå·ã‚’ã²ã</button>
  <br><br>
  <button id="reset-btn" onclick="resetDrawn()">ğŸ”„ æŠ½é¸ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
</div>
<div class="info">
  æœ€æ–°ç•ªå·ï¼š<b id="last-number">â€“</b><br>
  å‡ºãŸç•ªå·ï¼š<span id="numbers-list">ï¼ˆã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰</span>
</div>

<h2>ğŸŒ¸ å‚åŠ è€…ä¸€è¦§</h2>
<div id="players"></div>

<script>
/* ===== Firebase åˆæœŸåŒ– ===== */
firebase.initializeApp({
  apiKey: "AIzaSyCVofvlR6N837LqdNxRweTq93Uu6qpgbsI",
  authDomain: "sushi-cd085.firebaseapp.com",
  databaseURL: "https://sushi-cd085-default-rtdb.firebaseio.com",
  projectId: "sushi-cd085"
});
const db = firebase.database();

/* ===== åŸºæœ¬æƒ…å ± ===== */
const userId = localStorage.getItem("bingo_user_id");
if(!userId){
  alert("å‚åŠ æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚index.htmlã‹ã‚‰å‚åŠ ã—ã¦ãã ã•ã„ã€‚");
}

const cardEl = document.getElementById("bingo-card");
const lastEl = document.getElementById("last-number");
const listEl = document.getElementById("numbers-list");
const playersEl = document.getElementById("players");

let card = [];
let drawn = [];
let cardType = "red";

/* ===== è‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ ===== */
db.ref(`events/event1/participants/${userId}`).once("value").then(snap=>{
  const data = snap.val();
  if(!data || !data.card){
    alert("ã‚«ãƒ¼ãƒ‰æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  // ğŸ´ ã‚«ãƒ¼ãƒ‰æƒ…å ±
  card = data.card;
  cardType = data.cardType || "red";
  cardEl.className = `card-${cardType}`;
  renderCard();

  // ğŸ‘¤ è‡ªåˆ†ã®è¡¨ç¤º
  document.querySelector(".my-icon").textContent = data.icon || "ğŸ™‚";
  document.querySelector(".my-name").textContent = data.name;
});


/* ===== ã‚«ãƒ¼ãƒ‰æç”» ===== */
function renderCard(){
  cardEl.innerHTML="";
  card.forEach(v=>{
    const d = document.createElement("div");
    d.className="cell";
    d.textContent = v;
    if(v==="FREE" || drawn.includes(v)) d.classList.add("marked");
    cardEl.appendChild(d);
  });
}

/* ===== æŠ½é¸ç•ªå·åŒæœŸ ===== */
db.ref("events/event1/drawnNumbers").on("value", snap=>{
  drawn = snap.val() || [];
  lastEl.textContent = drawn.at(-1) ?? "â€“";
  listEl.textContent = drawn.length ? drawn.join("ãƒ»") : "ï¼ˆã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰";
  renderCard();
  checkStatus();
});

/* ===== ãƒªãƒ¼ãƒï¼ãƒ“ãƒ³ã‚´åˆ¤å®š ===== */
function checkStatus(){
  if(!card.length) return;

  const marked = card.map(v => v==="FREE" || drawn.includes(v));
  const lines = [];

  for(let r=0;r<5;r++) lines.push([0,1,2,3,4].map(c=>marked[r*5+c]));
  for(let c=0;c<5;c++) lines.push([0,1,2,3,4].map(r=>marked[r*5+c]));
  lines.push([0,6,12,18,24].map(i=>marked[i]));
  lines.push([4,8,12,16,20].map(i=>marked[i]));

  let status="å‚åŠ ä¸­";
  if(lines.some(l=>l.every(v=>v))) {
  status = "ãƒ“ãƒ³ã‚´";
  playBingoEffect(); // ğŸ† è¿½åŠ 
}
  else if(lines.some(l=>l.filter(v=>v).length===4)) status="ãƒªãƒ¼ãƒ";

  db.ref(`events/event1/participants/${userId}/status`).set(status);
}

/* ===== å‚åŠ è€…ä¸€è¦§ ===== */
db.ref("events/event1/participants").on("value", snap=>{
  playersEl.innerHTML="";
  const data = snap.val();
  if(!data) return;

  Object.values(data).forEach(p=>{
    const div = document.createElement("div");
    div.className="player";
    div.innerHTML = `
      <span>${p.icon || "ğŸ™‚"}</span>
      <span>${p.name}</span>
      <span class="status">${p.status}</span>
    `;
    playersEl.appendChild(div);
  });
});
/* ===== æŠ½é¸å‡¦ç† ===== */
function drawNumber(){
  if(drawn.length >= 75){
    alert("ã™ã¹ã¦ã®ç•ªå·ãŒå‡ºã¾ã—ãŸï¼");
    return;
  }

  let n;
  do{
    n = Math.floor(Math.random() * 75) + 1;
  }while(drawn.includes(n));

  // Firebaseã«ä¿å­˜ï¼ˆå…¨å“¡ã«åŒæœŸã•ã‚Œã‚‹ï¼‰
  db.ref("events/event1/drawnNumbers").set([...drawn, n]);
}
// ğŸµ ãƒ“ãƒ³ã‚´åŠ¹æœéŸ³ãƒªã‚¹ãƒˆ
const bingoSounds = [
  "bingo1.mp3",
  "bingo2.mp3",
  "bingo3.mp3"
];

let bingoPlayed = false;

function playBingoEffect(){
  if(bingoPlayed) return;
  bingoPlayed = true;

  // ğŸ”Š åŠ¹æœéŸ³ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
  const sound = document.getElementById("bingo-sound");
  const randomSound = bingoSounds[Math.floor(Math.random() * bingoSounds.length)];
  sound.src = randomSound;
  sound.volume = 0.6;
  sound.currentTime = 0;
  sound.play().catch(()=>{});

  // ğŸ† èŠ±ç«
  const fw = document.getElementById("fireworks");

  for(let i=0;i<12;i++){
    const d = document.createElement("div");
    d.className = "firework";
    d.style.left = Math.random()*100 + "%";
    d.style.top = Math.random()*60 + "%";
    d.style.background = `hsl(${Math.random()*360},100%,60%)`;
    fw.appendChild(d);

    setTimeout(()=>d.remove(), 1300);
  }
}
/* ===== æŠ½é¸ç•ªå·ãƒªã‚»ãƒƒãƒˆ ===== */
function resetDrawn(){
  if(!confirm("æŠ½é¸ç•ªå·ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;

  // æŠ½é¸ç•ªå·ã‚’ç©ºã«æˆ»ã™
  db.ref("events/event1/drawnNumbers").set([]);

  // è‡ªåˆ†å´ã®çŠ¶æ…‹ã‚‚å¿µã®ãŸã‚åˆæœŸåŒ–
  drawn = [];
  bingoPlayed = false; // â† ãƒ“ãƒ³ã‚´æ¼”å‡ºã‚‚å†åº¦å‡ºã›ã‚‹ã‚ˆã†ã«
}
</script>
<!-- ğŸ† ãƒ“ãƒ³ã‚´æ¼”å‡º -->
<div id="fireworks"></div>

<audio id="bingo-sound" preload="auto"></audio>

</body>
</html>
